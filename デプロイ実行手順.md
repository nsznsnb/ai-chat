# AI Chat - デプロイ実行手順

このドキュメントでは、AI ChatアプリケーションをGCP Cloud Runにデプロイする手順を段階的に説明します。

## 📋 事前準備チェックリスト

以下がすべて準備できているか確認してください：

- [ ] Googleアカウント
- [ ] Claude API キー（[こちらから取得](https://console.anthropic.com/)）
- [ ] クレジットカード（GCP無料枠利用でも必要）

## ステップ1: Google Cloud SDK のインストール

### 1-1. インストーラーをダウンロード

1. [Google Cloud SDK Installer](https://cloud.google.com/sdk/docs/install) にアクセス
2. Windows用インストーラー（64ビット）をダウンロード

### 1-2. インストール実行

1. ダウンロードした `GoogleCloudSDKInstaller.exe` を実行
2. インストールウィザードに従って進める
3. すべてデフォルト設定でOK
4. **PowerShellを再起動**（重要）

### 1-3. インストール確認

PowerShellを開いて以下を実行：

```powershell
gcloud --version
```

バージョン情報が表示されればOKです。

---

## ステップ2: GCP プロジェクトの認証と設定

### 2-1. Google アカウントで認証

```powershell
gcloud auth login
```

ブラウザが開くので、Googleアカウントでログインして認証を許可します。

### 2-2. プロジェクトを設定

```powershell
gcloud config set project extended-acumen-480510-c3
```

### 2-3. 必要なAPIを有効化

```powershell
gcloud services enable run.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable secretmanager.googleapis.com
gcloud services enable artifactregistry.googleapis.com
```

**注意**: API有効化には1〜2分かかる場合があります。

---

## ステップ3: Claude API キーの保存

### 3-1. APIキーを準備

[Anthropic Console](https://console.anthropic.com/) から Claude API キーをコピーします。
キーは `sk-ant-api03-` で始まる形式です。

### 3-2. Secret Manager に保存

**重要**: 以下の `sk-ant-api03-your-actual-api-key` を実際のAPIキーに置き換えてください。

```powershell
echo -n "sk-ant-api03-your-actual-api-key" | gcloud secrets create anthropic-api-key --data-file=-
```

**成功時の出力**:
```
Created secret [anthropic-api-key].
```

**既にシークレットが存在する場合**:
```powershell
# 既存を削除
gcloud secrets delete anthropic-api-key --quiet

# 再作成
echo -n "sk-ant-api03-your-actual-api-key" | gcloud secrets create anthropic-api-key --data-file=-
```

---

## ステップ4: サービスアカウントに権限を付与

以下のコマンドを実行して、Cloud RunがSecret Managerにアクセスできるようにします：

```powershell
# プロジェクト番号を取得
$PROJECT_NUMBER = gcloud projects describe extended-acumen-480510-c3 --format="value(projectNumber)"

# サービスアカウント名を構築
$SERVICE_ACCOUNT = "${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"

# 権限を付与
gcloud secrets add-iam-policy-binding anthropic-api-key `
  --member="serviceAccount:$SERVICE_ACCOUNT" `
  --role="roles/secretmanager.secretAccessor"
```

---

## ステップ5: Artifact Registry リポジトリの作成

```powershell
gcloud artifacts repositories create ai-chat-repo `
  --repository-format=docker `
  --location=asia-northeast1 `
  --description="AI Chat application repository"
```

**成功時の出力**:
```
Created repository [ai-chat-repo].
```

**既に存在する場合**: エラーが出ても問題ありません（次へ進む）

### Docker認証設定

```powershell
gcloud auth configure-docker asia-northeast1-docker.pkg.dev
```

---

## ステップ6: Dockerイメージのビルド

**注意**: このステップには3〜5分かかります。

```powershell
# プロジェクトのルートディレクトリに移動
cd c:\Users\ninis\Desktop\claude-practice\ai-chat

# Cloud Build でイメージをビルド＆プッシュ
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/extended-acumen-480510-c3/ai-chat-repo/ai-chat:latest
```

**ビルド成功時の出力**:
```
BUILD SUCCESS
ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
...
```

---

## ステップ7: Cloud Run へのデプロイ

```powershell
gcloud run deploy ai-chat `
  --image asia-northeast1-docker.pkg.dev/extended-acumen-480510-c3/ai-chat-repo/ai-chat:latest `
  --platform managed `
  --region asia-northeast1 `
  --allow-unauthenticated `
  --set-env-vars NODE_ENV=production,NEXT_PUBLIC_APP_NAME="AI Chat" `
  --update-secrets ANTHROPIC_API_KEY=anthropic-api-key:latest `
  --min-instances 0 `
  --max-instances 10 `
  --memory 512Mi `
  --cpu 1 `
  --timeout 60 `
  --concurrency 80 `
  --port 3000
```

**デプロイ成功時の出力**:
```
Service [ai-chat] revision [ai-chat-00001-xxx] has been deployed and is serving 100 percent of traffic.
Service URL: https://ai-chat-xxxxxxxxxx-an.a.run.app
```

**サービスURLをコピーしてください！**

---

## ステップ8: デプロイの確認

### 8-1. ヘルスチェック

```powershell
# サービスURLを取得
$SERVICE_URL = gcloud run services describe ai-chat --region asia-northeast1 --format="value(status.url)"

# ヘルスチェックAPI呼び出し
Invoke-WebRequest -Uri "${SERVICE_URL}/api/health" -UseBasicParsing
```

**成功時のレスポンス**:
```json
{
  "status": "ok",
  "timestamp": "2025-12-07T...",
  "uptime": 1.234,
  "environment": "production",
  "version": "1.0.0"
}
```

### 8-2. ブラウザで動作確認

1. サービスURL（`https://ai-chat-xxxxxxxxxx-an.a.run.app`）をブラウザで開く
2. チャット画面が表示される
3. メッセージを送信してAIの応答を確認

---

## 🎉 デプロイ完了！

おめでとうございます！AI ChatアプリケーションがCloud Runで稼働しています。

### 次のアクション

- **ログ確認**: [GCP Console](https://console.cloud.google.com/) > Cloud Run > ai-chat > ログ
- **メトリクス確認**: Cloud Console > Cloud Run > ai-chat > メトリクス
- **URLを共有**: サービスURLを友人と共有して使ってもらう

---

## 🔄 アプリケーションの更新方法

コードを変更した後、再デプロイする方法：

### 方法1: 自動スクリプト（簡単）

```powershell
.\deploy.ps1
```

### 方法2: 手動コマンド

```powershell
# 1. 新しいイメージをビルド
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/extended-acumen-480510-c3/ai-chat-repo/ai-chat:latest

# 2. 再デプロイ
gcloud run deploy ai-chat --region asia-northeast1
```

---

## 💰 コスト管理

### 予想コスト

- **最小インスタンス数0**: 使用していない時は課金なし
- **無料枠**: 月間200万リクエストまで無料
- **小規模利用**: 月額 $0〜$10程度

### コスト確認方法

[GCP Console](https://console.cloud.google.com/) > お支払い > レポート

---

## 🛑 サービスの停止・削除

### サービスを完全に削除

```powershell
gcloud run services delete ai-chat --region asia-northeast1
```

---

## ❓ トラブルシューティング

### Q: デプロイ後にアプリが動かない

**A**: ログを確認してください
```powershell
gcloud logging tail "resource.type=cloud_run_revision AND resource.labels.service_name=ai-chat"
```

### Q: ビルドが失敗する

**A**: ローカルで確認してください
```powershell
npm install
npm run build
```

### Q: APIキーのエラーが出る

**A**: Secret Managerの設定を確認してください
```powershell
gcloud secrets versions access latest --secret=anthropic-api-key
```

### Q: より詳しい手順が知りたい

**A**: 以下のドキュメントを参照してください：
- [SETUP_DEPLOY.md](SETUP_DEPLOY.md) - 完全ガイド
- [DEPLOY_GUIDE.md](DEPLOY_GUIDE.md) - 技術詳細

---

## 📞 サポート

問題が発生した場合は、以下のドキュメントを確認してください：

1. [SETUP_DEPLOY.md](SETUP_DEPLOY.md) - 初心者向け完全ガイド
2. [DEPLOY_GUIDE.md](DEPLOY_GUIDE.md) - 技術者向け詳細ガイド
3. [README.md](README.md) - プロジェクト全体の情報

---

**作成日**: 2025-12-07
**対象**: 初めてGCP Cloud Runにデプロイする方
**所要時間**: 約30分（初回のみ）
